name: CD

on:
    push:
        branches:
            - master
    workflow_dispatch:
        inputs:
            tag:
                description: 'Release tag (i.e. v1.2.3)'
                required: true
                type: string
            skip_ci_check:
                description: 'Skip CI status check'
                required: false
                type: boolean
                default: false

permissions:
    contents: write
    id-token: write

jobs:
    release:
        name: Publish NPM Release
        runs-on: ubuntu-latest
        environment: npm

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0

            -   name: Extract release tag
                id: tag
                run: |
                    TAG=${GITHUB_REF#refs/tags/}
                    if [[ ! $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
                      echo "Invalid tag format: $TAG"
                      echo "Expected format: v1.2.3, v1.2.3-rc.0, etc."
                      exit 1
                    fi
                    echo "tag=$TAG" >> $GITHUB_OUTPUT
                    echo "version=${TAG#v}" >> $GITHUB_OUTPUT

            -   name: Verify tag matches package.json version
                env:
                    RELEASE_TAG: ${{ steps.tag.outputs.tag }}
                    VERSION: ${{ steps.tag.outputs.version }}
                run: |
                    PACKAGE_VERSION=$(jq -r '.version' package.json)
                    if [[ "$PACKAGE_VERSION" != "$VERSION" ]]; then
                      echo "Version mismatch!"
                      echo "  Tag version: $VERSION"
                      echo "  Package.json version: $PACKAGE_VERSION"
                      exit 1
                    fi
                    echo "✅ Version verified: $VERSION"

            -   name: Check CI status for this commit
                env:
                    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: |
                    # Get the commit SHA for this tag
                    COMMIT_SHA=$(git rev-list -n 1 ${{ steps.tag.outputs.tag }})

                    echo "Checking CI status for commit: $COMMIT_SHA"

                    # Check if the CI workflow passed for this commit
                    CI_STATUS=$(gh run list \
                      --commit "$COMMIT_SHA" \
                      --workflow "ci.yml" \
                      --status completed \
                      --json status,conclusion \
                      -q '.[0]')

                    if [[ -z "$CI_STATUS" ]]; then
                      echo "⚠️ No CI run found for this commit"
                      echo "This might be a pre-existing tag. Proceeding with caution..."
                    else
                      CONCLUSION=$(echo "$CI_STATUS" | jq -r '.conclusion')
                      if [[ "$CONCLUSION" != "success" ]]; then
                        echo "❌ CI did not pass for this commit"
                        echo "Conclusion: $CONCLUSION"
                        exit 1
                      fi
                      echo "✅ CI checks passed for this commit"
                    fi

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '20'
                    cache: npm
                    registry-url: 'https://registry.npmjs.org'

            -   name: Install dependencies
                run: npm ci

            -   name: Type check
                run: npm run test:types

            -   name: Build
                run: npm run build

            -   name: Run tests
                run: npm test

            -   name: Publish to NPM with provenance
                run: npm publish --provenance

            -   name: Create GitHub Release
                env:
                    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    RELEASE_TAG: ${{ steps.tag.outputs.tag }}
                run: |
                    gh release create "$RELEASE_TAG" \
                      --title "$RELEASE_TAG" \
                      --generate-notes \
                      --draft

            -   name: Summary
                run: |
                    echo "## ✅ Release Published Successfully"
                    echo ""
                    echo "**Version:** ${{ steps.tag.outputs.tag }}"
                    echo "**NPM Package:** https://www.npmjs.com/package/singlie/v/${{ steps.tag.outputs.version }}"
                    echo "**GitHub Release:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.tag }} (draft)"
                    echo ""
                    echo "Next steps:"
                    echo "1. Review the draft release on GitHub"
                    echo "2. Publish the release to make it public"
