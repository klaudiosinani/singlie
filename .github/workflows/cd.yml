name: CD

on:
    workflow_run:
        workflows: [ 'CI' ]
        types:
            - completed
        branches:
            - master

permissions:
    contents: write
    id-token: write

jobs:
    verify_ci:
        name: Verify CI Success
        runs-on: ubuntu-latest
        steps:
            -   name: Check CI workflow result
                if: github.event.workflow_run.conclusion != 'success'
                run: |
                    echo "CI workflow failed or was cancelled"
                    exit 1

    check_release:
        name: Check Release Tag
        runs-on: ubuntu-latest
        needs: verify_ci
        outputs:
            proceed: ${{ steps.check_tag.outputs.proceed }}
            release_tag: ${{ steps.check_tag.outputs.release_tag }}
        steps:
            -   name: Checkout
                uses: actions/checkout@v4
                with:
                    ref: ${{ github.sha }}
                    fetch-depth: 0

            -   name: Check Release Tag Existence
                id: check_tag
                run: |
                    TAGS=$(git tag --points-at ${{ github.sha }} | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$' || true)

                    if [[ -z "$TAGS" ]]; then
                        echo "No release tag found for commit ${{ github.sha }}"
                        echo "proceed=false" >> $GITHUB_OUTPUT
                        exit 0
                    fi

                    TAG_COUNT=$(echo "$TAGS" | wc -l)
                    if [[ $TAG_COUNT -gt 1 ]]; then
                        echo "Multiple release tags found for this commit"
                        echo "$TAGS"
                        exit 1
                    fi

                    RELEASE_TAG="$TAGS"
                    echo "Found release tag: $RELEASE_TAG"
                    echo "proceed=true" >> $GITHUB_OUTPUT
                    echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

    release:
        name: Release
        runs-on: ubuntu-latest
        needs: check_release
        if: needs.check_release.outputs.proceed == 'true'
        environment: NPM
        steps:
            -   name: Checkout
                uses: actions/checkout@v4
                with:
                    ref: ${{ needs.check_release.outputs.release_tag }}
                    fetch-depth: 0

            -   name: Verify tag matches package.json version
                run: |
                    jq --raw-output --exit-status --arg tag "$RELEASE_TAG" '
                      if (.version == ($tag | ltrimstr("v"))) then
                        "Package version (\(.version)) matches tag version (\($tag | ltrimstr("v")))"
                      else
                        "Package version (\(.version)) does not match tag version (\($tag | ltrimstr("v")))" | halt_error(1)
                      end' package.json
                env:
                    RELEASE_TAG: ${{ needs.check_release.outputs.release_tag }}

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version-file: package.json
                    cache: npm
                    registry-url: https://registry.npmjs.org

            -   name: Install dependencies
                run: npm ci

            -   name: Build
                run: npm run build

            -   name: Publish to NPM
                run: npm publish --provenance

            -   name: Create GitHub Release
                run: |
                    gh release create "$RELEASE_TAG" \
                        --title "$RELEASE_TAG" \
                        --draft \
                        --generate-notes
                env:
                    RELEASE_TAG: ${{ needs.check_release.outputs.release_tag }}
                    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
